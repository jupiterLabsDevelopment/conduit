# Conduit Operator Guide

<!-- markdownlint-disable MD036 MD040 MD007 -->

This guide walks through bootstrapping the Conduit MVP stack, connecting a Minecraft server, and troubleshooting common issues.

---

## 1. Architecture at a Glance

```text
[ Browser UI ] ⇄ HTTPS ⇄ [ Conduit API ] ⇄ WS ⇄ [ Agent ] ⇄ WS ⇄ [ Minecraft Management API ]
                                            │
                                            └── Postgres
```

* **Conduit API** — Go service that handles REST, WebSocket fanout, RBAC, and audit logging.
* **Admin UI** — React SPA for issuing commands and viewing live events.
* **Postgres** — Persistence for users, servers, sessions, audit logs, and cached schema.

---

## 2. Prerequisites

* Docker & Docker Compose **or** individual runtimes (Go 1.22+, Node 18+, Postgres 16).
* Access to a Minecraft server with the **Management API** enabled.
* TLS certificate/keystore for the Minecraft management endpoint (self-signed is acceptable for dev).

Minecraft `server.properties` excerpt:

```properties
management-server-enabled=true
management-server-host=127.0.0.1
management-server-port=24464
management-server-tls-enabled=true
management-server-tls-keystore=/path/to/keystore.p12
# Password via env or JVM option
```

Set the management API bearer token via environment (preferred):

```bash
MC_MGMT_TOKEN=super-secret-token
```

---

## 3. Environment Variables

| Component | Variable | Description |
|-----------|----------|-------------|
| API | `PG_DSN` | Postgres connection string (e.g. `postgres://conduit:conduit@db:5432/conduit?sslmode=disable`) |
| API | `JWT_SECRET` | HS256 signing key for user sessions |
| API | `PORT` | HTTP listen port (default `8080`) |
| Agent | `CONDUIT_API_WS` | WebSocket endpoint exposed by the API (e.g. `ws://api:8080/agent/connect`) |
| Agent | `CONDUIT_AGENT_TOKEN` | Token issued when registering a server in Conduit |
| Agent | `MC_MGMT_WS` | Management API WebSocket URL (e.g. `wss://127.0.0.1:24464`) |
| Agent | `MC_MGMT_TOKEN` | Minecraft management bearer token |
| Agent | `MC_TLS_MODE` | Optional override (`strict`, `skip`); defaults to `strict` when unset |
| Agent | `MC_TLS_INSECURE` | Legacy toggle; prefer `MC_TLS_MODE=skip` for local/dev only |
| Agent | `MC_TLS_ROOT_CA` | Path to PEM file containing additional root CA certificates |
| Agent | `MC_TLS_SERVER_NAME` | Override TLS SNI/server name when connecting to an IP |
| Agent | `MC_TLS_HANDSHAKE_TIMEOUT` | WebSocket dial timeout (Go duration, default `15s`) |
| Agent | `AGENT_BACKOFF_INITIAL` | Initial reconnect delay (Go duration, default `1s`) |
| Agent | `AGENT_BACKOFF_MAX` | Maximum backoff delay (default `30s`) |
| Agent | `AGENT_BACKOFF_MULTIPLIER` | Exponential backoff multiplier (default `2.0`) |
| Agent | `AGENT_BACKOFF_JITTER` | Random jitter added to backoff delay (default `500ms`) |
| Agent | `AGENT_TELEMETRY_INTERVAL` | Interval for aggregated telemetry logs (default `60s`) |
| UI | `VITE_API_BASE` | REST base URL exposed by Conduit API |
| UI | `VITE_API_WS` | WebSocket base URL for event streams |

> **Tip:** copy `.env.example` files (generated by Docker Compose) and adjust for production deployments.

---

## 4. Quick Start with Docker Compose

1. Copy `deploy/docker-compose.yml` and `.env` templates to your environment.
2. Run the stack:

   ```bash
   docker compose --project-directory deploy up --build
   ```

3. Wait for services: Postgres, API (`:8080`), UI (`:5173`), and agent (`:9000`).
4. Visit `http://localhost:5173` to access the admin UI.

To stop the stack:

```bash
docker compose --project-directory deploy down
```

---

## 5. Bootstrap the First Owner

1. Open the UI and choose **Bootstrap owner**.
2. Supply the email/password for the first account. This will create an owner user and persist a JWT session.
3. Subsequent logins use the same credentials; additional users can be created later via API endpoints.

The API prevents bootstrap once a user exists, returning HTTP 403 if attempted again.

---

## 6. Register a Minecraft Server

1. From the **Servers** page, click **Create server**.
2. Copy the generated **Agent token**. The UI will continue to display it until you dismiss the banner.
3. On the agent host, set:

   ```bash
   export CONDUIT_API_WS="ws://localhost:8080/agent/connect"
   export CONDUIT_AGENT_TOKEN="<token from UI>"
   export MC_MGMT_WS="wss://127.0.0.1:24464"
   export MC_MGMT_TOKEN="<minecraft management token>"
   export MC_TLS_INSECURE="true"   # dev only
   ```

4. Start the agent binary (see `agents/mc-agent`). The agent will:
   * Establish WS to the Conduit API.
   * Establish WS to the Minecraft Management API.
   * Forward `rpc.discover` results back to Conduit for caching.

---

## 7. Working with the UI

* **Servers list** — view connection status, last seen time, and agent token (during creation).
* **Server detail** —
   * **Players** tab includes allowlist/operator actions.
   * **Game rules** tab shows individual controls plus bulk presets for curating multiple changes at once. Moderators and owners can select a preset, preview the affected rules/settings, and review per-field status after applying.
   * **Critical actions** let owners trigger `minecraft:server/stop`; moderators can run `minecraft:server/save`.
   * **Live events** stream notifications with `minecraft:notification/*` payloads.
   * **Discovered schema** shows the cached `rpc.discover` response.
   * **Audit log** tab lists recent actions and provides a CSV export button for compliance snapshots.
* Use the **Sign out** button in the header to revoke the active session immediately (server-side revocation is enforced).

RBAC guardrails:

* `owner` → full control.
* `moderator` → non-destructive RPC (allowlist, operators, save).
* `viewer` → read-only access and event subscriptions.

---

## 8. Troubleshooting

| Symptom | Possible Cause | Remediation |
|---------|----------------|-------------|
| UI shows "Agent not connected" | Agent WebSocket not connected | Verify `CONDUIT_AGENT_TOKEN`, API URL, and network reachability |
| `rpc.discover` missing schema | Agent unable to reach Minecraft | Check `MC_MGMT_WS`, TLS settings, and management server logs |
| Login fails after bootstrapping | JWT secret changed or session expired | Clear browser storage and re-login; ensure `JWT_SECRET` remains stable |
| WebSocket fails with TLS error | Self-signed cert without `MC_TLS_INSECURE` | Set `MC_TLS_INSECURE=true` for dev or install a trusted cert |

---

## 9. Manual Deployment (Without Compose)

1. **Postgres** — create `conduit` database and run migrations under `deploy/migrations` (e.g. via `golang-migrate`).
2. **API** — build `apps/api/cmd/api` binary, configure env vars, and run behind HTTPS.
3. **UI** — `npm install && npm run build` in `apps/ui`, then serve `dist/` via CDN or reverse proxy.
4. **Agent** — build `agents/mc-agent` and deploy alongside the Minecraft server.

Ensure networks between API ↔ Agent and UI ↔ API are secured (TLS, firewall rules).

---

## 10. Agent Telemetry & Reconnect Controls

The agent now exposes configurable reconnect timings and emits structured telemetry:

* **Reconnect tuning** — adjust `AGENT_BACKOFF_INITIAL`, `AGENT_BACKOFF_MAX`, `AGENT_BACKOFF_MULTIPLIER`, and `AGENT_BACKOFF_JITTER` to match your network stability. Defaults are tuned for quick recovery without overwhelming the API.
* **Telemetry** — every `AGENT_TELEMETRY_INTERVAL` (default 60s) the agent logs a JSON snapshot summarizing session counts, dial failures, message throughput, and last error. Forward these logs to your SIEM for visibility.
* **Dial timeout** — configure `MC_TLS_HANDSHAKE_TIMEOUT` to guard against hung TLS handshakes. Production operators should prefer slightly higher values (e.g. `20s`) when running behind load balancers.

Example agent log excerpt:

```json
{
   "level": "INFO",
   "component": "telemetry",
   "msg": "agent telemetry snapshot",
   "sessions_total": 4,
   "session_failures_total": 1,
   "messages_forwarded_api_to_mc": 128,
   "messages_forwarded_mc_to_api": 132,
   "dial_failures_total": {"minecraft": 1}
}
```

### Shipping telemetry logs

1. Point your log shipper (Fluent Bit, Vector, Filebeat, CloudWatch Agent, etc.) at the agent output and filter for entries where `component` equals `telemetry`.
2. Forward those records to your centralized observability stack (Elastic/Loki/Splunk/Datadog) to retain history and build dashboards.
3. Optionally parse the JSON payload into structured metrics so you can alert via Prometheus, Datadog, CloudWatch, or equivalent when session failures or dial errors spike.

---

## 11. Configure TLS for the Minecraft Management API

Follow these steps to serve the Minecraft management endpoint over TLS with a custom certificate and secured password handling.

1. **Create or import a certificate**
    * To generate a self-signed certificate for testing:

       ```bash
       keytool -genkeypair \
          -alias mc-mgmt \
          -keyalg RSA \
          -keysize 4096 \
          -validity 825 \
          -storetype PKCS12 \
          -keystore /opt/minecraft/ssl/mc-mgmt.p12 \
          -storepass "$(openssl rand -base64 24)"
       ```

    * To import an issued certificate (PEM key/cert chain):

       ```bash
       openssl pkcs12 -export \
          -inkey privkey.pem \
          -in fullchain.pem \
          -name mc-mgmt \
          -out /opt/minecraft/ssl/mc-mgmt.p12
       ```

2. **Lock down filesystem permissions**
    * Store the `.p12` file somewhere only the `minecraft` service account can read (e.g. `/opt/minecraft/ssl/`).
    * Apply restrictive permissions:

       ```bash
       chown minecraft:minecraft /opt/minecraft/ssl/mc-mgmt.p12
       chmod 600 /opt/minecraft/ssl/mc-mgmt.p12
       ```

3. **Expose the keystore to the server**
    * Add or update the TLS fields in `server.properties`:

       ```properties
       management-server-tls-enabled=true
       management-server-tls-keystore=/opt/minecraft/ssl/mc-mgmt.p12
       management-server-tls-keystore-password=${env:MC_TLS_KEYSTORE_PASSWORD}
       ```

    * The `${env:VAR}` syntax ships with 1.20.5+; if your version does not support interpolation, omit the third line and set the password via JVM options instead (next step).

4. **Provide the password at runtime**
    * Export the password before starting the server (systemd unit, shell profile, or `.env` file read by your launcher):

       ```bash
       export MC_TLS_KEYSTORE_PASSWORD="super-secret-passphrase"
       ```

    * If environment substitution is unavailable, pass the password as a JVM property. Append to `user_jvm_args.txt` or the launch command:

       ```text
       -Dmanagement-server.tls.keystore.password=${MC_TLS_KEYSTORE_PASSWORD}
       ```

       With the property set, the `server.properties` entry `management-server-tls-keystore-password` can be left blank.

5. **Restart and verify**
    * Restart the Minecraft server and confirm it logs `Management server listening on https://...`.
    * From the Conduit agent host, you can run:

       ```bash
       openssl s_client -connect 127.0.0.1:24464 -servername minecraft.local </dev/null
       ```

       Ensure the certificate chain matches the keystore you configured.

6. **Update the Conduit agent**
    * Set `MC_MGMT_WS` to the `wss://` endpoint and, if using a private CA, point `MC_TLS_ROOT_CA` at the PEM bundle that contains the issuing certificate.
    * Leave `MC_TLS_MODE` at `strict` for production. Only use `skip` or `MC_TLS_INSECURE=true` while testing self-signed certs.

> **Tip:** Rotate the keystore password periodically and update any systemd secrets or environment files in lockstep. Recycle the Minecraft management process after each rotation.

---

## 12. Security Considerations

* **TLS validation** — production deployments should keep TLS verification enabled (`MC_TLS_MODE=strict`) and, when using private PKI, load custom roots via `MC_TLS_ROOT_CA`. Reserve `MC_TLS_MODE=skip` (or `MC_TLS_INSECURE=true`) for isolated development only.
* **Certificate pinning** — supply `MC_TLS_SERVER_NAME` when connecting via IP addresses to avoid relying on default SNI detection.
* **Secrets management** — store `CONDUIT_AGENT_TOKEN` and `MC_MGMT_TOKEN` in a secret manager and inject via environment instead of committing to disk.
* **Audit exports** — the UI’s CSV download reflects the server-side export endpoint and includes all moderation actions. Rotate exports into your compliance archive periodically.

---

## 13. Upgrade Notes

* Agents must be restarted to pick up the new telemetry and backoff knobs. Existing env files remain compatible; new fields are optional with safe defaults.
* The UI now surfaces bulk game rule presets. Moderators should review preset definitions in the API if customising before applying in production.
* When adding bespoke TLS roots, ensure the PEM bundle is mounted into the agent container and referenced by `MC_TLS_ROOT_CA`.

---

## 14. Support & Feedback

* File issues in the repository.
* Share diagnostic logs (`--json` output from services) for deeper investigations.

Stay tuned for future releases adding multi-tenancy, hosted relay, and typed RPC tooling.
